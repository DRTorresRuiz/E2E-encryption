<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="utf-8">
        <title>E2E</title>
        <meta name="description" content="" />
        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
        <!-- .shiftr.io -->
        <script src="https://assets.shiftr.io/js/mqtt-2.9.0.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
      <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    </head>
    <body style="background-color: #e2f0fb">
    <nav class="navbar navbar-expand-lg navbar-dark text-white bg-primary">
  <a class="navbar-brand" href="#">End to End</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
    <li class="nav-item dropdown active">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Actions
    </a>
    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
        <a class="dropdown-item" href="#" onclick="activeDiv('registerForm')">Register device</a>
        <a class="dropdown-item" href="#" onclick="activeDiv('subscribeTopic')">Subscribe to a new topic</a>
        <a class="dropdown-item" href="#" onclick="activeDiv('deviceList')">List devices/topics</a>
        <a class="dropdown-item" href="#"  onclick="Swal.fire({icon: 'success',title: 'You are listening all topics', showConfirmButton: false,timer: 2500});">Listen all topics</a>
    </div>
    </li>
      <li class="nav-item active">
        <a class="nav-link" href="#" >Instructions</a>
      </li>

    </ul>
    <form class="form-inline my-2 my-lg-0" action="/">
        <button class="btn btn-danger my-2 my-sm-0" style="margin-right:20px" type="submit" onclick="" href="/"> Log out </button>
    </form>
    <form class="form-inline my-2 my-lg-0">
      <button class="btn btn-outline-light my-2 my-sm-0" type="button" onclick="Swal.fire({
          icon: 'question',
          title: 'Do you need some help?',
          confirmButtonText: 'Understood!',
          html : '<b>Click on actions and select:</b></br>-Register a new device </br>-Get the list with devices </br>-Topics or listen all topics'
      } )">Help</button>
    </form>
  </div>
</nav>
        <div class="main">
            <div class="container">
                <h1 align="center" style="margin-top:25px;">End to End</h1>      
                    <div id="registerForm" name="registerForm" >
                    <form action="">
                        <div class="row justify-content-md-center" style="margin-top:25px">
                            <div class="col col-sm-3" style="text-align:right;font-size:22px">
                             <label for="device">Synchronize new device</label>
                            </div>
                          <div class=" justify-content-md-right" >
                                 <button type="submit" onclick=""style ="margin-left:10px"class="btn btn-primary">Synchronize</button>
                             </div>
                         </div>
                     </form>
                     </div>
        <div id="deviceList" name="deviceList" style="display:none">
            <table  class="table table-striped table-light table-bordered" style=" text-align: center">
                <tr >
                    <th>Devices</th>
                    <th>Topics</th>
                    <th>Delete</th>
                </tr>
                <tr>
                    <td> Device 1 </td>
                    <td> Topic 1</td>
                    <td> <button type="button" class="btn btn-danger">Unsynchronize</button></td>
                </tr>
                 <tr>
                    <td> Device 2 </td>
                    <td> Topic 2 </td>
                    <td> <button type="button" class="btn btn-danger">Unsynchronize</button></td>
                </tr>
               {% if listDeviceTopic %}
                    {% for k,v in listDeviceTopic.items  %}
                    <tr>
                       <td> {{ k }} </td>                    
                       <td> {{ v }} </td>  
                       <td> <button type="button" class="btn btn-danger">Unsynchronize</button></td>
                       <!--Eliminar del fichero y del kms-->   
                    </tr>
                     {% endfor %}
                {% endif %}
            </table>            
        </div>   




        <div id="subscribeTopic" name="subscribeTopic" style="display:none">
            <form action="">
            <div class="row justify-content-md-center" style="margin-top:25px">
                <div class="col col-sm-3" style="text-align:right;font-size:22px">
                    <label for="newTopic">Subscribe to a new topic</label>
                </div>
                    <div class="col-md-auto">
                        <input type="text" class="form-control" id="newTopic" name="newTopic"  placeholder="Enter topic">
                    </div>
                    <button type="button" style =""class="btn btn-primary" onclick="subscribeNewTopic()">Subscribe</button>
                    <button type="button" style ="margin-left:5px"class="btn btn-warning" onclick="subscribeOnlyThisNewTopic()">Subscribe only this topic</button>
            </div>
            </form>
        </div>


        <div class="row" style ="margin-top:40px;">
            <div class="justify-content-md-right">
                 <iframe src="https://shiftr.io/ruiz14/e2e-encryption/embed?zoom=1" width="500" height="275" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen allowtransparency="true"></iframe>
            </div>
            <div id="message" name="message" class="justify-content-md-left" style =" background-color:#ffffff;width:450px;height:275px;margin-left:150px; overflow-y: scroll;" >
                 <h3> Reading from mqtt topic</h3>
            </div>
        </div>

        

    </div>
    </div>
        
    </body>
    <script>
        function subscribeNewTopic(){
            var topic =  $('#newTopic').val();
            if(topic!=''){         
                var newTopic = '/'+topic;   
                listTopic.push(newTopic); 
                client.subscribe(newTopic);
        $('#message').append("You have subscribed to " + newTopic+ "<br>");                        
            }else{
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Enter the topic, please',
                    })
            }
        }
    </script>

    <script>
        function subscribeOnlyThisNewTopic(){
                    var topic =  $('#newTopic').val();
                    if(topic!=''){         
                        var newTopic = '/'+topic;                               
                        for(var cadena in listTopic){
                                client.unsubscribe(listTopic[cadena]);
                                $('#message').append("You are not subscribed to " + listTopic[cadena]+ "<br>");
                        }
                        listTopic=[];
                        listTopic.push(newTopic);
                        client.subscribe(newTopic);          
                $('#message').append("You have subscribed to " + newTopic+ "<br>");                         
                    }else{
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Enter the topic, please',
                            })
                    }
                }
    </script>
    <script>
    var listTopic = [];
        var string="Conexi√≥n realizada: <br>";
        $('#message').append(string);  
        var client = mqtt.connect('mqtt://platform:platform-MUII@broker.shiftr.io', {
            clientId: 'javascript'
    });
        client.on('connect', function(){
            client.subscribe('/register');     
        // client.unsubscribe('/example');

        });

        client.on('message', function(topic, message) {
            var obj = JSON.stringify(message);
            //Call python function here to decrypt message
               /$.ajax({
                type: "POST",
                url: "/message",
                data: { param: message}
                }).done(function( o ) {
                // do something
                });*/
                var string= topic+': '+message+'<br>';
                 $('#message').append(string);

                 /*
                 $.getJSON('URL GET WITH URL PARAMS', 
                    function(data, textStatus, jqXHR) {
                        alert(data);
                    }
                )(WAY 2)*/
            
        });

    </script>
    <script>
    function activeDiv(div){
        var divList = ["registerForm", "deviceList", "subscribeTopic"];
        for(var cadena in divList){
            if(div == divList[cadena]){
               document.getElementById(divList[cadena]).style.display = "block";
               
         
            }else{
                 document.getElementById(divList[cadena]).style.display = "none";
                 
            }
        }
    }
    </script>
    <script>
        /*var mqttMessage;
        mqttClient.subscribe("https://shiftr.io/");
        mqttClient.on('message', function(topic, message) {
        mqttMessage = message.toString();
        })*/
        
    </script>


</html>